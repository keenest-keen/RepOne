<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Confirm code</title>
	<style>
		form {
			width: 340px;
		}
		.form-label {
			display: inline-block;
			width: 100px
		}
		.status {
			display: none;
		}
		fieldset {
			margin-top: 15px;
		}
	</style>
	<script src="./jquery.min.js"></script>
	<script>
		var SERVER_URL = 'http://localhost:3000',	// путь к серверу
			INTERVAL = 0.5,							// интервал запроса состояния кодов (в секундах)
			REDIRECT_PAUSE = 2;						// через сколько секунд осуществлять переадресацию после успешной верификации данных
		
		$(function () {
			var fGetStatus,
				fParseURL,
				fDraw,
				fResend,
				captcha;
				
			$.ajaxSetup({
				type: 'POST',				
				dataType: 'jsonp'
			});				
			$('#labelredirect').hide();
			
			fParseURL = function (href) {
				var a = document.createElement('a');
				a.href = href;
				return a;
			};
			
			fDraw = function (x) {
				if (x.phone) {
					$('.status-phone__yes').show();
					$('.status-phone__no').hide();
				}
				else {
					$('.status-phone__yes').hide();
					$('.status-phone__no').show();
				}
				if (x.email) {
					$('.status-email__yes').show();
					$('.status-email__no').hide();
				}
				else {
					$('.status-email__yes').hide();
					$('.status-email__no').show();
				}			
			};
			
			fGetStatus = function () {
				$.ajax({
					url: SERVER_URL + '/get_captcha_status',					
					data: { captcha: captcha },
					success: function (data) {
						console.log(data);
						fDraw(data);
												
						if (data.error || (!(data.phone && data.email ))) {
							setTimeout(function () {
								fGetStatus();
							}, INTERVAL * 1000);
							return;
						}
						else {
							if (data.phone && data.email) {
								$('#labelredirect').show();
								setTimeout(function () {
									window.location = './done.html';
								}, REDIRECT_PAUSE * 1000);
							}
						}
					}
				});
			};
			
			fResend = function (media) {
				$.ajax({
					url: SERVER_URL + '/resend',							
					data: { captcha: captcha, media: media },
					success: function (data) {
						if (data.status != 'ok') {
							alert('Сервер вернул ошибку: ' + data.error);
						}
					}
				});
			};
			
			$('#btnsend').click(function () {
				var code = $('#confirmcode').val();
				
				$.ajax({
					url: SERVER_URL + '/confirm_code',
					data: { code: code },
					success: function (data) {
						console.log(data);
						if (data.status != 'ok') {
							alert('Сервер вернул ошибку: ' + data.error);
						}						
					}
				});
				
				return false;
			});
			
			$('#btnResendEmail').click(function () {
				fResend('email');
				return false;
			});
			
			$('#btnResendSms').click(function () {
				fResend('sms');
				return false;
			});			
			
			captcha = fParseURL(document.location).search.replace('?', '');
			console.log(captcha);
			
			fGetStatus();
		});
	</script>
</head>
<body>
	<form action="/" method="POST">
		<label>Введите код подтверждения:</label><br/>
		<input type="text" id="confirmcode" placeholder="цифробуквенная комбинация" />
		<input type="submit" id="btnsend" value="Отправить">
		<fieldset>
			<label for="phone" class="form-label">Телефон</label>
			<label class="status status-phone__yes">Подтверждено</label>
			<label class="status status-phone__no">Неподтверждено</label>
			<br/>
			<label for="email" class="form-label">E-mail</label>
			<label class="status status-email__yes">Подтверждено</label>
			<label class="status status-email__no">Неподтверждено</label>
		</fieldset>				
		<input type="submit" id="btnResendEmail" value="Повторно отправить email">
		<input type="submit" id="btnResendSms" value="Повторно отправить sms"><br/>
		
		<label id="labelredirect">Данные успешно отправлены. Сейчас вы будете перенаправлены.</label><br/>
	</form>
</body>
</html>
