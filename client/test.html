<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Test</title>
	<style>
		form {
			width: 540px;
		}
		.form-label {
			display: inline-block;
			width: 100px
		}
		.status {
			display: none;
		}
	</style>
	<script src="./jquery.min.js"></script>
	<script>
		var SERVER_URL = 'http://192.168.0.110:3000',	// путь к серверу
			INTERVAL = 10,								// частота запроса статуса подтверждения введённых данных (в секундах)
			captcha,
			done = false;
		
		$(function () {	
			var fGetStatus,
				fDraw;
				
			fDraw = function (x) {		
				console.log('fDraw()');
				if (x.phone) {
					$('.status-phone__yes').show();
				}
				else {
					$('.status-phone__no').show();
				}
				if (x.email) {
					$('.status-email__yes').show();
				}
				else {
					$('.status-email__no').show();
				}
				
				if (x.email && x.phone ) {
					$('#btnnext').removeAttr('disabled');
				}
			};
			
			fGetStatus = function () {
				console.log('fGetStatus()');
				$.ajax({
					url: SERVER_URL + '/getstatus',
					type: 'POST',				
					dataType: 'jsonp',									
					data: { captcha: captcha },
					success: function (x) {	
						console.log('fGetStatus');						
						console.log(x);
						fDraw(x);
						if (x.error || (!(x.phone && x.email ))) {
							setTimeout(function () {								
								fGetStatus();
							}, INTERVAL * 1000);
							return;
						}												
					}
				});				
			};
									
			$('#btnsend').click(function () {
				var phone = $('#phone').val(),
					email = $('#email').val();
										
				if (!phone) {
					alert('Необходимо указать номер телефона.');
					return;
				}
				if (!email) {
					alert('Необходимо указать email.');
					return;
				}
				console.log('/sendrequest');
				$.ajax({
					url: SERVER_URL + '/sendrequest',
					type: 'POST',				
					dataType: 'jsonp',									
					data: { phone: phone, email: email },
					success: function (x) {	
						console.log(x);
						if (x.error) {
							alert('Ошибка: ' + x.error.message);
							return;
						}						
						captcha = x.captcha;
						
						fDraw(x);						
						
						if (x.phone && x.email) {
							if ($('#check').is(':checked')) {
								$('#btnnext').click();
							}
						}
						else {
							setTimeout(function () {
								fGetStatus();
							}, INTERVAL * 1000);
						}
					}
				});
				
				return false;
			});			
			
			$('#btnnext').click(function () {				
				alert('Проверка завершена, всё хорошо, переход осуществлён.');
				return false;
			});
		});
	</script>
</head>
<body>
	<form action="/" method="POST">
		<label>Text</label><br/>
		<fieldset>
			<label for="phone" class="form-label">Телефон</label><input type="tel" id="phone">
			<label class="status status-phone__yes">Подтверждено</label>
			<label class="status status-phone__no">Неподтверждено</label>
			<br/>
			<label for="email" class="form-label">E-mail</label><input type="email" id="email">
			<label class="status status-email__yes">Подтверждено</label>
			<label class="status status-email__no">Неподтверждено</label>
		</fieldset>
		<input type="checkbox" id="check"><label for="check">Продолжить сразу после подтверждения данных</label><br/>
		<input type="submit" id="btnsend" value="Отправить">
		<input type="submit" id="btnnext" value="Продолжить" disabled="1">
	</form>
</body>
</html>

